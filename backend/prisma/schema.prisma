// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  products    Product[]

  @@map("categories")
}

model Currency {
  id            Int            @id @default(autoincrement())
  code          String          @unique // ISO 4217 code (USD, EUR, GBP, etc.)
  name          String
  symbol        String
  isDefault     Boolean         @default(false) @map("is_default")
  isActive      Boolean         @default(true) @map("is_active")
  decimalPlaces Int             @default(2) @map("decimal_places")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  exchangeRates ExchangeRate[]  @relation("FromCurrency")
  exchangeRatesTo ExchangeRate[] @relation("ToCurrency")
  products      Product[]
  sales         Sale[]

  @@map("currencies")
}

model ExchangeRate {
  id            Int      @id @default(autoincrement())
  fromCurrencyId Int     @map("from_currency_id")
  toCurrencyId   Int     @map("to_currency_id")
  rate          Decimal   @db.Decimal(10, 6) // Exchange rate
  effectiveDate DateTime  @default(now()) @map("effective_date")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  fromCurrency  Currency  @relation("FromCurrency", fields: [fromCurrencyId], references: [id])
  toCurrency    Currency  @relation("ToCurrency", fields: [toCurrencyId], references: [id])

  @@unique([fromCurrencyId, toCurrencyId, effectiveDate])
  @@map("exchange_rates")
}

model Product {
  id            Int      @id @default(autoincrement())
  name          String
  sku           String   @unique
  categoryId    Int      @map("category_id")
  costPrice     Decimal  @map("cost_price") @db.Decimal(10, 2)
  sellingPrice  Decimal? @map("selling_price") @db.Decimal(10, 2)
  currencyId    Int?     @map("currency_id") // Product's base currency
  description   String?
  stockQuantity Int      @default(0) @map("stock_quantity")
  reorderLevel  Int      @default(10) @map("reorder_level")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  category      Category @relation(fields: [categoryId], references: [id])
  currency      Currency? @relation(fields: [currencyId], references: [id])
  salesItems    SalesItem[]

  @@map("products")
}

model TaxSetting {
  id          Int      @id @default(autoincrement())
  defaultRate Decimal  @default(0) @map("default_rate") @db.Decimal(5, 2)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("tax_settings")
}

model Sale {
  id            Int         @id @default(autoincrement())
  date          DateTime    @default(now())
  customerCode  String?     @map("customer_code")
  customerName  String?     @map("customer_name")
  invoiceNumber String?     @map("invoice_number")
  subtotal      Decimal     @db.Decimal(10, 2)
  taxAmount     Decimal     @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount Decimal    @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount   Decimal     @map("total_amount") @db.Decimal(10, 2)
  taxRate       Decimal     @map("tax_rate") @db.Decimal(5, 2)
  currencyId    Int?        @map("currency_id") // Sale currency
  exchangeRate  Decimal?    @map("exchange_rate") @db.Decimal(10, 6) // Rate used at time of sale
  status        String      @default("completed")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  currency      Currency?   @relation(fields: [currencyId], references: [id])
  salesItems    SalesItem[]

  @@map("sales")
}

model SalesItem {
  id           Int      @id @default(autoincrement())
  saleId       Int      @map("sale_id")
  productId    Int      @map("product_id")
  quantity     Int
  costPrice    Decimal  @map("cost_price") @db.Decimal(10, 2)
  sellingPrice Decimal  @map("selling_price") @db.Decimal(10, 2)
  profit       Decimal  @db.Decimal(10, 2)
  taxApplied   Decimal  @default(0) @map("tax_applied") @db.Decimal(10, 2)
  sale         Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id])

  @@map("sales_items")
}

model Receivable {
  id            Int      @id @default(autoincrement())
  date          DateTime @default(now())
  invoiceNumber String?  @map("invoice_number")
  customerName  String?  @map("customer_name")
  customerCode  String?  @map("customer_code")
  amount        Decimal  @db.Decimal(10, 2)
  received      Decimal  @default(0) @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("receivables")
}
